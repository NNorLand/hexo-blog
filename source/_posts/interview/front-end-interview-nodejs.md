---
title: 前端面试总结之NodeJS
categories:
  - interview
date: 2019-07-23 22:34:17
updated: 2019-07-23 22:34:17
tags: [NodeJs, JavaScript]
---
## koa 中间件机制

## 事件循环

借助libuv
[Node.js 事件循环，定时器和 process.nextTick()
](https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/)

```text
   ┌───────────────────────────┐
┌─>│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │<─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
```

1. 定时器：本阶段执行已经安排的 setTimeout() 和 setInterval() 的回调函数。  
2. 待定回调：执行延迟到下一个循环迭代的 I/O 回调。某些系统错误的回调函数  
3. idle, prepare：仅系统内部使用。准备工作。  
4. 轮询：检索新的 I/O 事件;执行与 I/O 相关的回调（几乎所有情况下，除了关闭的回调函数，它们由计时器和 setImmediate() 排定的之外），其余情况 node 将在此处阻塞。
   如果轮训队列不为空，依次同步取出轮询队列中的第一个回调函数执行，直到轮询队列为空或者达到系统最大限制  
   如果轮询队列为空
      如果之前设置过setImmediate 阶段
         直接进入下一个check阶段
      如果之前没有设置过setImmediate
         在当前poll阶段等待
            直到轮询队列添加回调函数，就去第一个情况执行
            如果定时器到点了，也会去下一阶段
5. 检测：setImmediate() 回调函数在这里执行。  
6. 关闭的回调函数：一些准备关闭的回调函数，如：socket.on('close', ...)。  

process.nextTick 在任一阶段优先执行
